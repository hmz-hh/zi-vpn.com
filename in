#!/bin/bash
#hamza - PowerMX

# Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù„ÙŠ ØºØ§Ø¯ÙŠ ÙŠØ®Ø²Ù† ÙÙŠÙ‡ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚
FLAG_FILE="/tmp/first_run_check.flag"
ATTEMPT_FILE="/tmp/login_attempts.flag"
LOCK_FILE="/tmp/login_lock.flag"

# Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
MAX_ATTEMPTS=3
LOCK_TIME=120  # Ù…Ø¯Ø© Ø§Ù„Ø­Ø¸Ø± Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ (2 Ø¯Ù‚Ø§ÙŠÙ‚)

# ØªØ­Ù‚Ù‚ ÙˆØ§Ø´ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø±Ø§Ù‡ ØªØ¯Ø§Ø± ÙÙŠÙ‡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø¨Ù„
if [[ ! -f "$FLAG_FILE" ]]; then
    # Ø£ÙˆÙ„ Ù…Ø±Ø© ÙƒÙŠØªÙ†ÙØ° ÙÙŠÙ‡Ø§ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª
    if [[ -f "$LOCK_FILE" ]]; then
        LAST_LOCK_TIME=$(cat "$LOCK_FILE")
        CURRENT_TIME=$(date +%s)
        DIFF=$((CURRENT_TIME - LAST_LOCK_TIME))
        if (( DIFF < LOCK_TIME )); then
            REMAINING_TIME=$((LOCK_TIME - DIFF))
            echo -e "${RED}âŒ ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ù† Ø¨Ø¹Ø¯ ${REMAINING_TIME} Ø«Ø§Ù†ÙŠØ©.${NC}"
            exit 1
        else
            rm -f "$LOCK_FILE"
        fi
    fi

    if [[ -f "$ATTEMPT_FILE" ]]; then
        ATTEMPTS=$(cat "$ATTEMPT_FILE")
    else
        ATTEMPTS=0
    fi

    while (( ATTEMPTS < MAX_ATTEMPTS )); do
        clear
        echo -e "${YELLOW}ğŸ” Secure Access Panel${NC}"
        read -sp "ğŸ”’ Enter password to access: " pass
        echo ""
        if [[ "$pass" == "HAMZAZIDANE200" ]]; then
            echo -e "${GREEN}âœ… Password verified successfully.${NC}"
            touch "$FLAG_FILE"
            rm -f "$ATTEMPT_FILE"
            exit 0
        else
            ((ATTEMPTS++))
            echo -e "${RED}âŒ Wrong password. Attempts left: $((MAX_ATTEMPTS - ATTEMPTS))${NC}"
            echo "$ATTEMPTS" > "$ATTEMPT_FILE"
        fi
    done

    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø­Ø¸Ø±
    date +%s > "$LOCK_FILE"
    echo -e "${RED}âŒ Access Denied! Too many failed attempts. Try again in 2 minutes.${NC}"
    exit 1
else
    echo -e "${GREEN}âœ… Password already verified. Proceeding with script execution.${NC}"
fi

# Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù„ÙˆØ§Ù†
tput sgr0

# Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª ÙƒÙŠØªÙ†ÙØ° Ù‡Ù†Ø§

    if [[ -f "$ATTEMPT_FILE" ]]; then
        ATTEMPTS=$(cat "$ATTEMPT_FILE")
    else
        ATTEMPTS=0
    fi

    while (( ATTEMPTS < MAX_ATTEMPTS )); do
        clear
        echo -e "${YELLOW}ğŸ” Secure Access Panel${NC}"
        read -sp "ğŸ”’ Enter password to access: " pass
        echo ""
        if [[ "$pass" == "HAMZAZIDANE200" ]]; then
            echo -e "${GREEN}âœ… Password verified successfully.${NC}"
            touch "$FLAG_FILE"
            rm -f "$ATTEMPT_FILE"
            exit 0
        else
            ((ATTEMPTS++))
            echo -e "${RED}âŒ Wrong password. Attempts left: $((MAX_ATTEMPTS - ATTEMPTS))${NC}"
            echo "$ATTEMPTS" > "$ATTEMPT_FILE"
        fi
    done

    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø­Ø¸Ø±
    date +%s > "$LOCK_FILE"
    echo -e "${RED}âŒ Access Denied! Too many failed attempts. Try again in 2 minutes.${NC}"
    exit 1
else
    echo -e "${GREEN}âœ… Password already verified. Proceeding with script execution.${NC}"
fi

#installv1
function installv1(){
echo -e "${RED} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ "
echo -e "${YELLOW}This option will install ZIVPN version 1, UDP port range will be 20000:50000 redirected to 5666"
echo -e "${YELLOW}Continue?"
while [[ ${yesno} != @(s|S|y|Y|n|N) ]]; do
read -p "[Y/N]: " yesno
tput cuu1 && tput dl1
done
if [[ ${yesno} = @(s|S|y|Y) ]]; then
echo -e "${YELLOW}INSTALLING.."
bash <(curl -fsSL https://raw.githubusercontent.com/hq-mp/zi-vpn.com/refs/heads/main/inst1)
fi
}
#installv2
function installv2(){
echo -e "${RED} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ "
echo -e "${YELLOW}This option will install ZIVPN version 2 AMD, UDP port range will be 6000:19999 redirected to 5667"
echo -e "${YELLOW}Continue?"
while [[ ${yesno} != @(s|S|y|Y|n|N) ]]; do
read -p "[Y/N]: " yesno
tput cuu1 && tput dl1
done
if [[ ${yesno} = @(s|S|y|Y) ]]; then
echo -e "${YELLOW}INSTALLING.."
bash <(curl -fsSL https://raw.githubusercontent.com/powermx/zivpn/main/ziv2.sh)
fi
}
#installv3
function installv3(){
echo -e "${RED} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ "
echo -e "${YELLOW}This option will install ZIVPN version 2 ARM, UDP port range will be 6000:19999 redirected to 5667"
echo -e "${YELLOW}Continue?"
while [[ ${yesno} != @(s|S|y|Y|n|N) ]]; do
read -p "[Y/N]: " yesno
tput cuu1 && tput dl1
done
if [[ ${yesno} = @(s|S|y|Y) ]]; then
echo -e "${YELLOW}INSTALLING.."
bash <(curl -fsSL https://raw.githubusercontent.com/powermx/zivpn/main/ziv3.sh)
fi
}
#uninstall
function uninstall(){
echo -e "${RED} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ "
echo -e "${YELLOW}This option will uninstall the script ZIVPN server in any of its versions"
echo -e "${YELLOW}Continue?"
while [[ ${yesno} != @(s|S|y|Y|n|N) ]]; do
read -p "[Y/N]: " yesno
tput cuu1 && tput dl1
done
if [[ ${yesno} = @(s|S|y|Y) ]]; then
echo -e "${YELLOW}UNINSTALLING.."
bash <(curl -fsSL https://raw.githubusercontent.com/powermx/zivpn/main/uninstall.sh)
fi
}
#start
function startzivpn(){
echo -e "${RED} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ "
echo -e "${YELLOW}This option will start the Accounts udp ZIVPN server"
echo -e "${YELLOW}Continue?"
while [[ ${yesno} != @(s|S|y|Y|n|N) ]]; do
read -p "[Y/N]: " yesno
tput cuu1 && tput dl1
done
if [[ ${yesno} = @(s|S|y|Y) ]]; then
echo -e "${YELLOW}STARTING.."
    if [[ ${yesno} = @(s|S|y|Y) ]]; then
        echo -e "${YELLOW}Checking for ZiVPN services..."
        
        if [[ -f /etc/systemd/system/zivpn.service ]]; then
            echo -e "${YELLOW}Starting ZiVPN service..."
            sudo systemctl start zivpn.service
        fi
        if [[ -f /etc/systemd/system/zivpn_backfill.service ]]; then
            echo -e "${YELLOW}Starting ZiVPN Backfill service..."
            sudo systemctl start zivpn_backfill.service
        fi
        
        echo -e "${YELLOW}DONE!"
    fi
fi
}
#stop
function stopzivpn(){
echo -e "${RED} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ "
echo -e "${YELLOW}This option will stop the Accounts udp zivpn server"
echo -e "${YELLOW}Continue?"
while [[ ${yesno} != @(s|S|y|Y|n|N) ]]; do
read -p "[Y/N]: " yesno
tput cuu1 && tput dl1
done
if [[ ${yesno} = @(s|S|y|Y) ]]; then
echo -e "${YELLOW}STOPPING.."
    if [[ ${yesno} = @(s|S|y|Y) ]]; then
        echo -e "${YELLOW}Checking for ZiVPN services..."
        
        if [[ -f /etc/systemd/system/zivpn.service ]]; then
            echo -e "${YELLOW}Starting ZiVPN service..."
            sudo systemctl stop zivpn.service
        fi
        if [[ -f /etc/systemd/system/zivpn_backfill.service ]]; then
            echo -e "${YELLOW}Starting ZiVPN Backfill service..."
            sudo systemctl stop zivpn_backfill.service
        fi
        
        echo -e "${YELLOW}DONE!"
    fi
fi
}
m restart
function restartzivpn(){
echo -e "${RED} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ "
echo -e "${YELLOW}This option will restart the Accounts udp ZIVPN server"
echo -e "${YELLOW}Continue?"
while [[ ${yesno} != @(s|S|y|Y|n|N) ]]; do
read -p "[S/N]: " yesno
tput cuu1 && tput dl1
done
if [[ ${yesno} = @(s|S|y|Y) ]]; then
echo -e "${YELLOW}RESTARTING.."
    if [[ ${yesno} = @(s|S|y|Y) ]]; then
        echo -e "${YELLOW}Checking for ZiVPN services..."
        
        if [[ -f /etc/systemd/system/zivpn.service ]]; then
            echo -e "${YELLOW}Starting ZiVPN service..."
            sudo systemctl restart zivpn.service
        fi
        if [[ -f /etc/systemd/system/zivpn_backfill.service ]]; then
            echo -e "${YELLOW}Starting ZiVPN Backfill service..."
            sudo systemctl restart zivpn_backfill.service
        fi
        
        echo -e "${YELLOW}DONE!"
    fi
fi
}
  if [[ $1 == "" ]]; then
    clear && printf '\e[3J'
echo -e "${GRAY}${RED}${GRAY}${RED} â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ZIVPN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” "
echo -e "\033[91m â”‚ \033[91mIP :\033[0m $IP"

# OS
os=$(cat /etc/os-release | grep PRETTY_NAME | cut -d "=" -f 2- | tr -d '"')
echo -e "\033[91m â”‚\033[0m \033[91mOS :\033[0m $os"

# RAM
ram_total=$(free -m | awk 'NR==2 {print $2}')
ram_used=$(free -m | awk 'NR==2 {print $3}')
echo -e "\033[91m â”‚\033[0m \033[91mRAM :\033[0m $ram_used MB / $ram_total MB"

# ISP
isp=$(curl -s ip-api.com/json/$(curl -s ifconfig.me) | sed 's/.*"isp":"\([^"]*\).*/\1/')
echo -e "\033[91m â”‚\033[0m \033[91mISP :\033[0m $isp"

# City
city=$(curl -s ip-api.com/json/$(curl -s ifconfig.me) | sed 's/.*"city":"\([^"]*\).*/\1/')
echo -e "\033[91m â”‚\033[0m \033[91mCITY :\033[0m $city"
echo -e "${GRAY}${RED}${GRAY}${RED} â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HAMZA TECH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” "
echo -e "${YELLOW}      [${GREEN}1${YELLOW}] ${RED} ğŸ”‘ ${MAGENTA} INSTALL ZIVPN V2 ARM (5667)
${YELLOW}      [${GREEN}2${YELLOW}] ${RED} â• ${MAGENTA} INSTALL ZIVPN V2 AMD (5667)
${YELLOW}      [${GREEN}3${YELLOW}] ${RED} ğŸ“‹ ${MAGENTA} INSTALL ZIVPN V1 (5666)
${YELLOW}      [${GREEN}4${YELLOW}] ${RED} ğŸ—‘ï¸ ${MAGENTA} UNINSTALL SCRIPT ZIVPN
${YELLOW}      [${GREEN}5${YELLOW}] ${RED} â° ${MAGENTA} START ACCOUNT ZIVPN
${YELLOW}      [${GREEN}6${YELLOW}] ${RED} ğŸ”‘ ${MAGENTA} STOP ACCOUNT ZIVPN
${YELLOW}      [${GREEN}7${YELLOW}] ${RED} ğŸ’¾ ${MAGENTA} RESTART ACCOUNT ZIVPN
${YELLOW}      [${GREEN}0${YELLOW}] ${RED} ğŸšª ${MAGENTA} EXIT ZIVPN
${GRAY}${RED}${GRAY}${RED} â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ "
echo -e "\033[0m Select From Options [ 1 - 6 ] : \033[0m"
read -p " : " option
tput cuu1 >&2 && tput dl1 >&2
else
option=$1
fi
case $option in
  1 | 01 )
   installv3;;
  2 | 02 )
   installv1;;
  3 | 03 )
   installv2;;
  4 | 04)
   uninstall;;
  5 | 05)
   startzivpn;;
  6 | 06)
   stopzivpn;;
  7 | 07)
   restartzivpn;;
  0)
  exit;;
  *)
  continue;;
  esac
  break
  done
