#!/bin/bash

# zi-vpn.com
YELLOW="\033[1;33m" GREEN="\033[0;32m" RED="\033[0;31m" NC="\033[0m"
FLAG_FILE="/tmp/first_run_check.flag"
DOMAIN_FILE="/tmp/custom_domain"

# Fetch remote password
get_url() {
  echo "https://raw.githubusercontent.com/hq-mp/zi-vpn.com/refs/heads/main/zi-vpn.com"
}
get_password() {
  curl -s "$(get_url)"
}

# First-run password check
if [[ ! -f "$FLAG_FILE" ]]; then
  clear
  echo -e "${YELLOW}🔐  Secure Access Panel${NC}"
  echo -e "${YELLOW}🔐  Script is protected by password${NC}"
  echo -e "${YELLOW}🔐  To get the password, contact here @a_hamza_i${NC}"
  read -sp "🔐  Enter password to access: " pass
  echo
  remote_pass=$(get_password)
  if [[ "$pass" != "$remote_pass" ]]; then
    echo -e "${RED}❌  Access Denied! Wrong password.${NC}"
    exit 1
  fi
  touch "$FLAG_FILE"
  echo -e "${GREEN}✅  Password verified successfully.${NC}"
else
  echo -e "${GREEN}✅  Password already verified. Proceeding with script execution.${NC}"
fi

# Ensure running as root
if [[ $(id -u) -ne 0 ]]; then
  echo -e "${RED}Run the script as root user${NC}"
  exit 1
fi

# Load existing custom domain or default
if [[ -f "$DOMAIN_FILE" ]]; then
  DOMAIN="$(<"$DOMAIN_FILE")"
else
  DOMAIN="none"
fi

# --- FUNCTION DEFINITIONS ---

installv1(){ ... }   # your existing v1 installer
installv2(){ ... }   # your existing v2 AMD installer
installv3(){ ... }   # your existing v2 ARM installer
uninstall(){ ... }   # your existing uninstall
startzivpn(){ ... }  # your existing start
stopzivpn(){ ... }   # your existing stop
restartzivpn(){ ... }# your existing restart

change_domain(){
  echo -e "${YELLOW}── Change Domain Server ──${NC}"
  read -rp "Enter new domain: " newdomain
  echo "$newdomain" > "$DOMAIN_FILE"
  DOMAIN="$newdomain"
  echo -e "${GREEN}Domain set to:${NC} $DOMAIN"
  sleep 1
}

# --- MAIN MENU LOOP ---

while true; do
  clear && printf '\e[3J'
  IP=$(curl -4s icanhazip.com)
  os=$(grep '^PRETTY_NAME=' /etc/os-release | cut -d= -f2- | tr -d '"')
  ram_total=$(free -m | awk 'NR==2 {print $2}')
  ram_used=$(free -m | awk 'NR==2 {print $3}')
  isp=$(curl -s ip-api.com/json/"$IP" | sed -n 's/.*"isp":"[^"]*".*/\1/p')
  city=$(curl -s ip-api.com/json/"$IP" | sed -n 's/.*"city":"[^"]*".*/\1/p')

  echo -e "${RED}┌─────────────────── ZIVPN ──────────────────┐"
  echo -e "│ IP     : $IP"
  echo -e "│ OS     : $os"
  echo -e "│ RAM    : $ram_used MB / $ram_total MB"
  echo -e "│ ISP    : $isp"
  echo -e "│ CITY   : $city"
  echo -e "│ DOMAIN : $DOMAIN"
  echo -e "${RED}└────────────────────────────────────────────┘${NC}"

  cat <<EOF
${YELLOW}[${GREEN}1${YELLOW}]${MAGENTA} INSTALL ZIVPN V2 ARM (5667)
${YELLOW}[${GREEN}2${YELLOW}]${MAGENTA} INSTALL ZIVPN V2 AMD (5667)
${YELLOW}[${GREEN}3${YELLOW}]${MAGENTA} INSTALL ZIVPN V1 (5666)
${YELLOW}[${GREEN}4${YELLOW}]${MAGENTA} UNINSTALL SCRIPT ZIVPN
${YELLOW}[${GREEN}5${YELLOW}]${MAGENTA} START ACCOUNT ZIVPN
${YELLOW}[${GREEN}6${YELLOW}]${MAGENTA} STOP ACCOUNT ZIVPN
${YELLOW}[${GREEN}7${YELLOW}]${MAGENTA} RESTART ACCOUNT ZIVPN
${YELLOW}[${GREEN}8${YELLOW}]${MAGENTA} CHANGE DOMAIN SERVER
${YELLOW}[${GREEN}0${YELLOW}]${MAGENTA} EXIT ZIVPN
EOF

  read -rp $'\nSelect an option [0-8]: ' option
  case $option in
    1|01) installv3 ;;
    2|02) installv2 ;;
    3|03) installv1 ;;
    4|04) uninstall ;;
    5|05) startzivpn ;;
    6|06) stopzivpn ;;
    7|07) restartzivpn ;;
    8) change_domain ;;
    0) exit 0 ;;
    *) continue ;;
  esac
done
