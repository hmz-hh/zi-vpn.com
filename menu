#!/bin/bash

YELLOW="\033[1;33m"
GREEN="\033[0;32m"
RED="\033[0;31m"
NC="\033[0m"

FLAG_FILE="/tmp/first_run_check.flag"
BOT_TOKEN="7332449337:AAFRxi0cPjPLir90z_cvWxzOb_KXh-F2_fU"
ADMIN_ID="7432279779"

get_url() {
  echo "https://raw.githubusercontent.com/hq-mp/zi-vpn.com/refs/heads/main/zi-vpn.com"
}

get_password() {
  curl -s "$(get_url)"
}

send_to_telegram() {
  local message="$1"
  curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
       -d chat_id="${ADMIN_ID}" \
       -d text="${message}" > /dev/null
}

wait_for_approval() {
  echo -e "${YELLOW}âŒ› Ø§Ù†ØªØ¸Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø§Ø¯Ù…Ù† ÙÙ€ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…...${NC}"
  for i in {1..30}; do
    response=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getUpdates")
    if echo "$response" | grep -q "YES"; then
      return 0
    elif echo "$response" | grep -q "NO"; then
      return 1
    fi
    sleep 2
  done
  return 1
}

if [[ ! -f "$FLAG_FILE" ]]; then
  clear
  echo -e "${YELLOW}ğŸ” Script Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±${NC}"
  echo -e "${YELLOW}ğŸ” ØªÙˆØ§ØµÙ„ Ù…Ø¹ @a_hamza_i Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±${NC}"
  read -sp "ğŸ” Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: " pass
  echo ""

  remote_pass=$(get_password)

  if [[ "$pass" != "$remote_pass" ]]; then
    echo -e "${RED}âŒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.${NC}"
    exit 1
  fi

  send_to_telegram "âš ï¸ Ø·Ù„Ø¨ Ø¯Ø®ÙˆÙ„ Ø¬Ø¯ÙŠØ¯:\nIP: $(curl -s ifconfig.me)\nÙ†Ø¸Ø§Ù…: $(uname -o)\nØ±Ø¯ Ø¨ YES Ø£Ùˆ NO Ø¨Ø§Ø´ ØªÙˆØ§ÙÙ‚ Ø£Ùˆ ØªØ±ÙØ¶."
  if wait_for_approval; then
    touch "$FLAG_FILE"
    echo -e "${GREEN}âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©. Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ.${NC}"
  else
    echo -e "${RED}âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø·Ø±Ù Ø§Ù„Ø§Ø¯Ù…Ù†.${NC}"
    exit 1
  fi
else
  echo -e "${GREEN}âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø³Ø§Ø¨Ù‚Ù‹Ø§. ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¢Ù†.${NC}"
fi

# ---------------------- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£ØµÙ„ÙŠØ© ------------------------

install_all(){
  echo -e "${RED} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ "
  echo -e "${YELLOW}Ø³ÙŠØªÙ… ØªØ«Ø¨ÙŠØª Ø¬Ù…ÙŠØ¹ Ù†Ø³Ø® ZIVPN (V2 ARM, V1, V2 AMD)"
  echo -e "${YELLOW}Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ"
  while [[ ${yesno} != @(s|S|y|Y|n|N) ]]; do
    read -p "[Y/N]: " yesno
    tput cuu1 && tput dl1
  done
  if [[ ${yesno} = @(s|S|y|Y) ]]; then
    echo -e "${YELLOW}ØªØ«Ø¨ÙŠØª ZIVPN V2 ARM.."
    bash <(curl -fsSL https://raw.githubusercontent.com/powermx/zivpn/main/ziv3.sh)
    echo -e "${YELLOW}ØªØ«Ø¨ÙŠØª ZIVPN V1.."
    bash <(curl -fsSL https://raw.githubusercontent.com/hq-mp/zi-vpn.com/refs/heads/main/inst1)
    echo -e "${YELLOW}ØªØ«Ø¨ÙŠØª ZIVPN V2 AMD.."
    bash <(curl -fsSL https://raw.githubusercontent.com/powermx/zivpn/main/ziv2.sh)
  fi
}

uninstall(){
  echo -e "${RED} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ "
  echo -e "${YELLOW}Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ù†Ø³Ø® ZIVPN"
  echo -e "${YELLOW}Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ"
  while [[ ${yesno} != @(s|S|y|Y|n|N) ]]; do
    read -p "[Y/N]: " yesno
    tput cuu1 && tput dl1
  done
  if [[ ${yesno} = @(s|S|y|Y) ]]; then
    echo -e "${YELLOW}ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø§Ù„Ø­Ø°Ù.."
    bash <(curl -fsSL https://raw.githubusercontent.com/powermx/zivpn/main/uninstall.sh)
  fi
}

startzivpn(){
  echo -e "${YELLOW}ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø§Øª ZIVPN.."
  [[ -f /etc/systemd/system/zivpn.service ]] && sudo systemctl start zivpn.service
  [[ -f /etc/systemd/system/zivpn_backfill.service ]] && sudo systemctl start zivpn_backfill.service
  echo -e "${GREEN}âœ… ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„"
}

stopzivpn(){
  echo -e "${YELLOW}Ø¥ÙŠÙ‚Ø§Ù Ø®Ø¯Ù…Ø§Øª ZIVPN.."
  [[ -f /etc/systemd/system/zivpn.service ]] && sudo systemctl stop zivpn.service
  [[ -f /etc/systemd/system/zivpn_backfill.service ]] && sudo systemctl stop zivpn_backfill.service
  echo -e "${GREEN}âœ… ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù"
}

restartzivpn(){
  echo -e "${YELLOW}Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø§Øª ZIVPN.."
  [[ -f /etc/systemd/system/zivpn.service ]] && sudo systemctl restart zivpn.service
  [[ -f /etc/systemd/system/zivpn_backfill.service ]] && sudo systemctl restart zivpn_backfill.service
  echo -e "${GREEN}âœ… ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„"
}

changedomain(){
  echo -e "${YELLOW}Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ø·Ø§Ù‚ (domain):"
  read -p "Domain: " custom_domain
  echo "$custom_domain" > /tmp/zivpn_domain.txt
  echo -e "${GREEN}âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø·Ø§Ù‚: $custom_domain${NC}"
}

while true; do
  [[ $(id -u) -ne 0 ]] && echo -e "${RED}Ø´ØºÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª ÙƒÙ€ root!${NC}" && exit 1

  IP=$(curl -s -4 icanhazip.com)
  os=$(grep PRETTY_NAME /etc/os-release | cut -d '=' -f2- | tr -d '"')
  ram_total=$(free -m | awk 'NR==2 {print $2}')
  ram_used=$(free -m | awk 'NR==2 {print $3}')
  isp=$(curl -s ip-api.com/json/$(curl -s ifconfig.me) | grep -oP '(?<="isp":")[^"]+')
  city=$(curl -s ip-api.com/json/$(curl -s ifconfig.me) | grep -oP '(?<="city":")[^"]+')
  domain="not added"
  [[ -s /tmp/zivpn_domain.txt ]] && domain=$(cat /tmp/zivpn_domain.txt)

  clear && printf '\e[3J'
  echo -e "${RED} â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ZIVPN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
  echo -e "\033[91m â”‚ IP :\033[0m $IP"
  echo -e "\033[91m â”‚ OS :\033[0m $os"
  echo -e "\033[91m â”‚ RAM :\033[0m $ram_used MB / $ram_total MB"
  echo -e "\033[91m â”‚ ISP :\033[0m $isp"
  echo -e "\033[91m â”‚ CITY :\033[0m $city"
  echo -e "\033[91m â”‚ DOMAIN :\033[0m $domain"
  echo -e "${RED} â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HAMZA TECH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
  echo -e "${YELLOW} [${GREEN}1${YELLOW}] ØªØ«Ø¨ÙŠØª ZIVPN"
  echo -e "${YELLOW} [${GREEN}2${YELLOW}] Ø¥Ø²Ø§Ù„Ø© ZIVPN"
  echo -e "${YELLOW} [${GREEN}3${YELLOW}] ØªØ´ØºÙŠÙ„ ZIVPN"
  echo -e "${YELLOW} [${GREEN}4${YELLOW}] Ø¥ÙŠÙ‚Ø§Ù ZIVPN"
  echo -e "${YELLOW} [${GREEN}5${YELLOW}] Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ ZIVPN"
  echo -e "${YELLOW} [${GREEN}6${YELLOW}] ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†"
  echo -e "${YELLOW} [${GREEN}0${YELLOW}] Ø®Ø±ÙˆØ¬"
  echo -e "${RED} â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
  read -p " Ø§Ø®ØªØ± Ø±Ù‚Ù…: " option
  tput cuu1 >&2 && tput dl1 >&2
  case $option in
    1 ) install_all ;;
    2 ) uninstall ;;
    3 ) startzivpn ;;
    4 ) stopzivpn ;;
    5 ) restartzivpn ;;
    6 ) changedomain ;;
    0 ) exit ;;
    * ) continue ;;
  esac
  break
done
