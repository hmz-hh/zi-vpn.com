#!/bin/bash

# ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
CYAN="\033[0;36m"
MAGENTA="\033[1;35m"
NC="\033[0m"

FLAG_FILE="/tmp/first_run_check.flag"

# Ø±ÙˆØ§Ø¨Ø· GitHub
get_url() {
  echo "https://raw.githubusercontent.com/hq-mp/zi-vpn.com/refs/heads/main/zi-vpn.com"
}

get_password() {
  curl -s "$(get_url)"
}

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø£ÙˆÙ„ Ù…Ø±Ø©
if [[ ! -f "$FLAG_FILE" ]]; then
  clear
  echo -e "${YELLOW}ğŸ” Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± - ØªÙˆØ§ØµÙ„ Ù…Ø¹: @a_hamza_i${NC}"
  read -sp "ğŸ”‘ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: " pass
  echo ""
  remote_pass=$(get_password)
  if [[ "$pass" != "$remote_pass" ]]; then
    echo -e "${RED}âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø®Ø±ÙˆØ¬.${NC}"
    exit 1
  fi
  touch "$FLAG_FILE"
  echo -e "${GREEN}âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­.${NC}"
fi

# ÙˆØ¸Ø§Ø¦Ù ZIVPN
install_all() {
  echo -e "${YELLOW}âš™ï¸ ØªØ«Ø¨ÙŠØª Ø¬Ù…ÙŠØ¹ Ù†Ø³Ø® ZIVPN...${NC}"
  bash <(curl -fsSL https://raw.githubusercontent.com/powermx/zivpn/main/ziv3.sh)
  bash <(curl -fsSL https://raw.githubusercontent.com/hq-mp/zi-vpn.com/refs/heads/main/inst1)
  bash <(curl -fsSL https://raw.githubusercontent.com/powermx/zivpn/main/ziv2.sh)
  echo -e "${GREEN}âœ… ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª!${NC}"
}

uninstall() {
  echo -e "${RED}ğŸ§¹ Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ù†Ø³Ø® ZIVPN...${NC}"
  bash <(curl -fsSL https://raw.githubusercontent.com/powermx/zivpn/main/uninstall.sh)
  echo -e "${GREEN}âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù!${NC}"
}

startzivpn() {
  echo -e "${YELLOW}â–¶ï¸ Ø¨Ø¯Ø¡ Ø®Ø¯Ù…Ø§Øª ZIVPN...${NC}"
  systemctl start zivpn.service 2>/dev/null
  systemctl start zivpn_backfill.service 2>/dev/null
  echo -e "${GREEN}âœ… ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„${NC}"
}

stopzivpn() {
  echo -e "${YELLOW}â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø®Ø¯Ù…Ø§Øª ZIVPN...${NC}"
  systemctl stop zivpn.service 2>/dev/null
  systemctl stop zivpn_backfill.service 2>/dev/null
  echo -e "${GREEN}âœ… ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù${NC}"
}

restartzivpn() {
  echo -e "${YELLOW}ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø§Øª ZIVPN...${NC}"
  systemctl restart zivpn.service 2>/dev/null
  systemctl restart zivpn_backfill.service 2>/dev/null
  echo -e "${GREEN}âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©${NC}"
}

changedomain() {
  read -p "ğŸŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯: " custom_domain
  echo "$custom_domain" > /tmp/zivpn_domain.txt
  echo -e "${GREEN}âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†: $custom_domain${NC}"
}

# Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
IP=$(curl -s -4 ifconfig.me)
os=$(grep PRETTY_NAME /etc/os-release | cut -d '=' -f2- | tr -d '"')
ram_total=$(free -m | awk 'NR==2 {print $2}')
ram_used=$(free -m | awk 'NR==2 {print $3}')
isp=$(curl -s ip-api.com/json/$(curl -s ifconfig.me) | grep -oP '(?<="isp":")[^"]+')
city=$(curl -s ip-api.com/json/$(curl -s ifconfig.me) | grep -oP '(?<="city":")[^"]+')
domain="not added"
[[ -s /tmp/zivpn_domain.txt ]] && domain=$(cat /tmp/zivpn_domain.txt)

# ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
while true; do
  clear
  echo -e "${YELLOW}â˜…â”â”â”â”â”â”â”â”â”â” â˜† ZIVPN MANAGER â˜† â”â”â”â”â”â”â”â”â”â”â˜…"
  echo -e "${CYAN}ğŸŒ IP: $IP"
  echo -e "${CYAN}ğŸ’» OS: $os"
  echo -e "${CYAN}ğŸ§  RAM: $ram_used / $ram_total MB"
  echo -e "${CYAN}ğŸ¢ ISP: $isp"
  echo -e "${CYAN}ğŸ“ CITY: $city"
  echo -e "${CYAN}ğŸŒ DOMAIN: $domain"
  echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${GREEN}[1] â• CREATE ACCOUNT ZIVPN"
  echo -e "${GREEN}[2] ğŸ—‘ï¸ UNINSTALL SCRIPT"
  echo -e "${GREEN}[3] â–¶ï¸ START ZIVPN"
  echo -e "${GREEN}[4] â¹ï¸ STOP ZIVPN"
  echo -e "${GREEN}[5] ğŸ”„ RESTART ZIVPN"
  echo -e "${GREEN}[6] ğŸŒ CHANGE DOMAIN"
  echo -e "${RED}[0] ğŸšª EXIT"
  echo -ne "${YELLOW}âš™ï¸ Ø§Ø®ØªØ± Ø®ÙŠØ§Ø±: ${NC}"
  read option
  case $option in
    1) install_all ;;
    2) uninstall ;;
    3) startzivpn ;;
    4) stopzivpn ;;
    5) restartzivpn ;;
    6) changedomain ;;
    0) echo -e "${RED}ğŸšª Ø§Ù„Ø®Ø±ÙˆØ¬..."; exit 0 ;;
    *) echo -e "${RED}â— Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­..."; sleep 1 ;;
  esac
done
