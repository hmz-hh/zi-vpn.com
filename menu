#!/bin/bash

wget -q "https://raw.githubusercontent.com/hq-mp/zi-vpn.com/refs/heads/main/menu" -O /usr/local/bin/menu
chmod +x /usr/local/bin/menu

if ! grep -q '/usr/local/bin/menu' ~/.bashrc; then
  echo '[ -t 1 ] && /usr/local/bin/menu || true' >> ~/.bashrc
fi

YELLOW="\033[1;33m"
GREEN="\033[0;32m"
RED="\033[0;31m"
NC="\033[0m"

FLAG_FILE="/tmp/first_run_check.flag"

get_url() {
  # password: zivs123
  part1="https"; part2="://"; part3="raw"; part4=".github"; part5="usercontent"; part6=".com"; part7="/hq-mp"; part8="/zi-vpn.com"; part9="/refs"; part10="/heads"; part11="/main"; part12="/fake"
  echo "${part1}${part2}${part3}${part4}${part5}${part6}${part7}${part8}${part9}${part10}${part11}${part12}"
}

get_password() {
  curl -s "$(get_url)"
}

if [[ ! -f "$FLAG_FILE" ]]; then
  clear
  echo -e "${YELLOW} 🔐  Secure Access Panel${NC}"
  echo -e "${YELLOW} 🔐  Script is protected by password${NC}"
  echo -e "${YELLOW} 🔐  To get the password, contact here @a_hamza_i ${NC}"
  read -sp " 🔐  Enter password to access: " pass
  echo ""
  remote_pass=$(get_password)
  if [[ "$pass" != "$remote_pass" ]]; then
    echo -e "${RED} ❌  Access Denied! Wrong password.${NC}"
    exit 1
  fi
  touch "$FLAG_FILE"
  echo -e "${GREEN} ✅  Password verified successfully.${NC}"
fi

pause_and_return() {
  read -r _
  /usr/local/bin/menu
  exit
}

install_zivpn_v2_amd() {
  echo -e "${RED} ┌─────────────────── ZIVPN ──────────────────┐ "
  echo -e "${YELLOW} This will create a new account. You may lose previous accounts."
  while true; do
    read -p " Continue? [Y/N] : " yesno
    case "$yesno" in
      [Yy]|[Ss]) echo -e "${YELLOW}INSTALLING ZIVPN V2 AMD.."; bash <(curl -fsSL https://raw.githubusercontent.com/hq-mp/zi-vpn.com/refs/heads/main/ziv.sh); pause_and_return; break ;;
      [Nn]) /usr/local/bin/menu; exit ;;
      *) tput cuu1 && tput dl1 ;;
    esac
  done
}

uninstall() {
  echo -e "${RED} ┌─────────────────── ZIVPN ──────────────────┐ "
  echo -e "${YELLOW} This will uninstall ZIVPN versions"
  while true; do
    read -p " Continue? [Y/N] : " yesno
    case "$yesno" in
      [Yy]|[Ss]) echo -e "${YELLOW}UNINSTALLING.."; bash <(curl -fsSL https://raw.githubusercontent.com/powermx/zivpn/main/uninstall.sh); pause_and_return; break ;;
      [Nn]) /usr/local/bin/menu; exit ;;
      *) tput cuu1 && tput dl1 ;;
    esac
  done
}

startzivpn() {
  echo -e "${RED} ┌─────────────────── ZIVPN ──────────────────┐ "
  echo -e "${YELLOW} STARTING ZIVPN SERVICES.."
  [[ -f /etc/systemd/system/zivpn.service ]] && sudo systemctl start zivpn.service
  [[ -f /etc/systemd/system/zivpn_backfill.service ]] && sudo systemctl start zivpn_backfill.service
  echo -e "${GREEN} ✅ DONE!"
  pause_and_return
}

stopzivpn() {
  echo -e "${RED} ┌─────────────────── ZIVPN ──────────────────┐ "
  echo -e "${YELLOW} STOPPING ZIVPN SERVICES.."
  [[ -f /etc/systemd/system/zivpn.service ]] && sudo systemctl stop zivpn.service
  [[ -f /etc/systemd/system/zivpn_backfill.service ]] && sudo systemctl stop zivpn_backfill.service
  echo -e "${GREEN} ✅ DONE!"
  pause_and_return
}

restartzivpn() {
  echo -e "${RED} ┌─────────────────── ZIVPN ──────────────────┐ "
  echo -e "${YELLOW} RESTARTING ZIVPN SERVICES.."
  [[ -f /etc/systemd/system/zivpn.service ]] && sudo systemctl restart zivpn.service
  [[ -f /etc/systemd/system/zivpn_backfill.service ]] && sudo systemctl restart zivpn_backfill.service
  echo -e "${GREEN} ✅ DONE!"
  pause_and_return
}

changedomain() {
  echo -e "${RED} ┌────────────────── DOMAIN  ─────────────────┐ "
  echo -e "${YELLOW} Enter domain:"
  read -p " Domain: " custom_domain
  echo "$custom_domain" > /tmp/zivpn_domain.txt
  echo -e "${GREEN} ✅ Domain saved: $custom_domain${NC}"
  pause_and_return
}

while true; do
  [[ $(id -u) -ne 0 ]] && echo -e "${RED}Run as root!${NC}" && exit 1
  IP=$(curl -s -4 icanhazip.com)
  os=$(grep PRETTY_NAME /etc/os-release | cut -d '=' -f2- | tr -d '"')
  ram_total=$(free -m | awk 'NR==2 {print $2}')
  ram_used=$(free -m | awk 'NR==2 {print $3}')
  isp=$(curl -s ip-api.com/json/$(curl -s ifconfig.me) | grep -oP '(?<="isp":")[^"]+')
  city=$(curl -s ip-api.com/json/$(curl -s ifconfig.me) | grep -oP '(?<="city":")[^"]+')
  domain="not added"; [[ -s /tmp/zivpn_domain.txt ]] && domain=$(cat /tmp/zivpn_domain.txt)

  clear && printf '\e[3J'
  echo -e "${RED} ┌─────────────────── ZIVPN ──────────────────┐"
  echo -e "\033[91m │ \033[91mIP :\033[0m $IP"
  echo -e "\033[91m │\033[91m OS :\033[0m $os"
  echo -e "\033[91m │\033[91m RAM :\033[0m $ram_used MB / $ram_total MB"
  echo -e "\033[91m │\033[91m ISP :\033[0m $isp"
  echo -e "\033[91m │\033[91m CITY :\033[0m $city"
  echo -e "\033[91m │\033[91m DOMAIN :\033[0m $domain"
  echo -e "${RED} ┌──────────────── HAMZA TECH ────────────────┐"
  echo -e "${YELLOW}      [${GREEN}1${YELLOW}] ${RED} . CREATE ACCOUNT UDP ZIVPN"
  echo -e "${YELLOW}      [${GREEN}2${YELLOW}] ${RED} . UNINSTALL SCRIPT ZIVPN"
  echo -e "${YELLOW}      [${GREEN}3${YELLOW}] ${RED} . START ACCOUNT ZIVPN"
  echo -e "${YELLOW}      [${GREEN}4${YELLOW}] ${RED} . STOP ACCOUNT ZIVPN"
  echo -e "${YELLOW}      [${GREEN}5${YELLOW}] ${RED} . RESTART ACCOUNT ZIVPN"
  echo -e "${YELLOW}      [${GREEN}6${YELLOW}] ${RED} . CHANGE DOMAIN SERVER"
  echo -e "${YELLOW}      [${GREEN}0${YELLOW}] ${RED} . EXIT ZIVPN"
  echo -e "${RED} └────────────────────────────────────────────┘"
  echo -e "\033[0m         Select From Options [ 1 - 6 ] : \033[0m"
  read -p " : " option
  tput cuu1 >&2 && tput dl1 >&2
  case $option in
    1 ) install_zivpn_v2_amd ;;
    2 ) uninstall ;;
    3 ) startzivpn ;;
    4 ) stopzivpn ;;
    5 ) restartzivpn ;;
    6 ) changedomain ;;
    0 ) exit ;;
    * ) continue ;;
  esac
done
