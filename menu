#!/bin/bash

YELLOW="\033[1;33m"
GREEN="\033[0;32m"
RED="\033[0;31m"
NC="\033[0m"

FLAG_FILE="/tmp/first_run_check.flag"
DOMAIN_FILE="/tmp/zivpn_domain.txt"

get_url() {
local p1="https://raw.githubusercontent.com"
local p2="/hq-mp"
local p3="/zi-vpn.com"
local p4="/refs/heads/main"
local p5="/zi-vpn.com"
echo "${p1}${p2}${p3}${p4}${p5}"
}

get_password() {
curl -s "$(get_url)"
}

if [[ ! -f "$FLAG_FILE" ]]; then
clear
echo -e "${YELLOW}🔐  Secure Access Panel${NC}"
echo -e "${YELLOW}🔐  Script is protected by password${NC}"
echo -e "${YELLOW}🔐  To get the password, contact here @a_hamza_i ${NC}"
read -sp "🔐  Enter password to access: " pass
echo ""

remote_pass=$(get_password)  

if [[ "$pass" != "$remote_pass" ]]; then  
    echo -e "${RED}❌  Access Denied! Wrong password.${NC}"  
    exit 1  
fi  

touch "$FLAG_FILE"  
echo -e "${GREEN}✅  Password verified successfully.${NC}"
else
echo -e "${GREEN}✅  Password already verified. Proceeding with script execution.${NC}"
fi

function add_domain(){
    echo -e "${YELLOW}Enter the domain you want to display:"
    read -p "Domain: " user_domain
    echo "$user_domain" > "$DOMAIN_FILE"
    echo -e "${GREEN}Domain saved successfully.${NC}"
    sleep 1
}

function get_domain(){
    if [[ -f "$DOMAIN_FILE" ]]; then
        cat "$DOMAIN_FILE"
    else
        echo "Not set"
    fi
}

#menu
while true; do
if [ $(id -u) -ne 0 ]; then
echo -e "Run the script as root user"
exit
fi

if [[ $1 == "" ]]; then
clear && printf '\e[3J'
echo -e "${GRAY}${RED}${GRAY}${RED} ┌─────────────────── ZIVPN ──────────────────┐"
IP=$(curl -s -4 icanhazip.com)
echo -e "\033[91m │ \033[91mIP :\033[0m $IP"

os=$(grep PRETTY_NAME /etc/os-release | cut -d '=' -f2- | tr -d '"')
echo -e "\033[91m │\033[0m \033[91mOS :\033[0m $os"

ram_total=$(free -m | awk 'NR==2 {print $2}')
ram_used=$(free -m | awk 'NR==2 {print $3}')
echo -e "\033[91m │\033[0m \033[91mRAM :\033[0m $ram_used MB / $ram_total MB"

isp=$(curl -s ip-api.com/json/$(curl -s ifconfig.me) | grep -oP '"isp":"\K[^"]+')
echo -e "\033[91m │\033[0m \033[91mISP :\033[0m $isp"

city=$(curl -s ip-api.com/json/$(curl -s ifconfig.me) | grep -oP '"city":"\K[^"]+')
echo -e "\033[91m │\033[0m \033[91mCITY :\033[0m $city"

domain=$(get_domain)
echo -e "\033[91m │\033[0m \033[91mDOMAIN :\033[0m $domain"
echo -e "${GRAY}${RED}${GRAY}${RED} ┌──────────────── HAMZA TECH ────────────────┐"
echo -e "${YELLOW}      [${GREEN}1${YELLOW}] ${RED} . ${MAGENTA} INSTALL ZIVPN V2 ARM (5667)
${YELLOW}      [${GREEN}2${YELLOW}] ${RED} . ${MAGENTA} INSTALL ZIVPN V2 AMD (5667)
${YELLOW}      [${GREEN}3${YELLOW}] ${RED} . ${MAGENTA} INSTALL ZIVPN V1 (5666)
${YELLOW}      [${GREEN}4${YELLOW}] ${RED} . ${MAGENTA} UNINSTALL SCRIPT ZIVPN
${YELLOW}      [${GREEN}5${YELLOW}] ${RED} . ${MAGENTA} START ACCOUNT ZIVPN
${YELLOW}      [${GREEN}6${YELLOW}] ${RED} . ${MAGENTA} STOP ACCOUNT ZIVPN
${YELLOW}      [${GREEN}7${YELLOW}] ${RED} . ${MAGENTA} RESTART ACCOUNT ZIVPN
${YELLOW}      [${GREEN}9${YELLOW}] ${RED} . ${MAGENTA} ADD A DOMAIN
${YELLOW}      [${GREEN}0${YELLOW}] ${RED} . ${MAGENTA} EXIT ZIVPN"
echo -e "${GRAY}${RED}${GRAY}${RED} └────────────────────────────────────────────┘"
echo -e "\033[0m       Select From Options [ 0 - 9 ] : \033[0m"
read -p " : " option
tput cuu1 >&2 && tput dl1 >&2
else
option=$1
fi

case $option in
1 | 01 )
installv3;;
2 | 02 )
installv1;;
3 | 03 )
installv2;;
4 | 04 )
uninstall;;
5 | 05 )
startzivpn;;
6 | 06 )
stopzivpn;;
7 | 07 )
restartzivpn;;
9 | 09 )
add_domain;;
0 )
exit;;
* )
continue;;
esac
break
done
